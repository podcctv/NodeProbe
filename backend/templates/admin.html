<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>NodeProbe Admin</title>
</head>
<body>
    <h1>Test Records Admin</h1>
    <p><a href="/admin/logout">Logout</a></p>
    {% if user.must_change_password %}
    <p style="color:red;">You are using the default password. Please change it.</p>
    <button onclick="location.href='/admin/password'">Change Password</button>
    {% endif %}
    <section>
        <h2>Add / Edit Record</h2>
        <form id="recordForm">
            <input type="hidden" name="id">
            <label>Client IP: <input name="client_ip"></label><br>
            <label>Location: <input name="location"></label><br>
            <label>ASN: <input name="asn"></label><br>
            <label>ISP: <input name="isp"></label><br>
            <label>Date: <input name="date" type="date"></label><br>
            <label>Ping Avg(ms): <input name="ping_ms" type="number" step="0.01"></label><br>
            <label>Ping Min(ms): <input name="ping_min_ms" type="number" step="0.01"></label><br>
            <label>Ping Max(ms): <input name="ping_max_ms" type="number" step="0.01"></label><br>
            <label>Single DL(Mbps): <input name="single_dl_mbps" type="number" step="0.01"></label><br>
            <label>Single UL(Mbps): <input name="single_ul_mbps" type="number" step="0.01"></label><br>
            <label>Multi DL(Mbps): <input name="multi_dl_mbps" type="number" step="0.01"></label><br>
            <label>Multi UL(Mbps): <input name="multi_ul_mbps" type="number" step="0.01"></label><br>
            <label>Test Target: <input name="test_target"></label><br>
            <button type="submit">Save</button>
        </form>
    </section>
    <section>
        <h2>Existing Records</h2>
        <button id="deleteSelected">Delete Selected</button>
        <button id="exportExcel">Export to Excel</button>
        <table border="1" id="recordsTable">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>ID</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Client IP</th>
                    <th>Location</th>
                    <th>ASN</th>
                    <th>ISP</th>
                    <th>Ping Avg(ms)</th>
                    <th>Ping Min(ms)</th>
                    <th>Ping Max(ms)</th>
                    <th>Single DL(Mbps)</th>
                    <th>Single UL(Mbps)</th>
                    <th>Multi DL(Mbps)</th>
                    <th>Multi UL(Mbps)</th>
                    <th>Target</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div id="pagination">
            <button id="prevPage">Prev</button>
            <span id="pageInfo"></span>
            <button id="nextPage">Next</button>
        </div>
    </section>
<script>
const pageSize = 100;
let currentPage = 1;
let totalRecords = 0;
let currentRecords = [];

async function loadRecords(page = 1) {
    const offset = (page - 1) * pageSize;
    const res = await fetch(`/admin/tests?offset=${offset}&limit=${pageSize}`);
    if (res.status === 403) {
        // User is required to change the default password before accessing data
        window.location.href = '/admin/password';
        return;
    }
    if (!res.ok) {
        console.error('Failed to load records', res.status);
        return;
    }
    const data = await res.json();
    const tbody = document.querySelector('#recordsTable tbody');
    tbody.innerHTML = '';
    currentRecords = data.records || [];
    totalRecords = data.total || 0;
    currentPage = page;
    currentRecords.forEach(rec => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="checkbox" value="${rec.id}"></td>
            <td>${rec.id}</td>
            <td>${rec.date || ''}</td>
            <td>${rec.time_hour || ''}</td>
            <td>${rec.client_ip || ''}</td>
            <td>${rec.location || ''}</td>
            <td>${rec.asn || ''}</td>
            <td>${rec.isp || ''}</td>
            <td>${rec.ping_ms ?? ''}</td>
            <td>${rec.ping_min_ms ?? ''}</td>
            <td>${rec.ping_max_ms ?? ''}</td>
            <td>${rec.single_dl_mbps ?? ''}</td>
            <td>${rec.single_ul_mbps ?? ''}</td>
            <td>${rec.multi_dl_mbps ?? ''}</td>
            <td>${rec.multi_ul_mbps ?? ''}</td>
            <td>${rec.test_target || ''}</td>
            <td><button data-edit="${rec.id}">Edit</button><button data-del="${rec.id}">Delete</button></td>
        `;
        tbody.appendChild(tr);
    });
    document.getElementById('selectAll').checked = false;
    const totalPages = Math.ceil(totalRecords / pageSize) || 1;
    document.getElementById('pageInfo').textContent = `Page ${currentPage} / ${totalPages}`;
}

document.getElementById('recordForm').addEventListener('submit', async e => {
    e.preventDefault();
    const form = e.target;
    const data = Object.fromEntries(new FormData(form).entries());
    const id = data.id;
    delete data.id;
    const method = id ? 'PUT' : 'POST';
    const url = id ? `/admin/tests/${id}` : '/admin/tests';
    await fetch(url, {
        method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
    form.reset();
    loadRecords(currentPage);
});

document.getElementById('recordsTable').addEventListener('click', async e => {
    const editId = e.target.getAttribute('data-edit');
    const delId = e.target.getAttribute('data-del');
    if (editId) {
        const rec = currentRecords.find(r => r.id == editId);
        if (rec) {
            const form = document.getElementById('recordForm');
            form.id.value = rec.id;
            form.client_ip.value = rec.client_ip || '';
            form.location.value = rec.location || '';
            form.asn.value = rec.asn || '';
            form.isp.value = rec.isp || '';
            form.date.value = rec.date || '';
            form.ping_ms.value = rec.ping_ms ?? '';
            form.ping_min_ms.value = rec.ping_min_ms ?? '';
            form.ping_max_ms.value = rec.ping_max_ms ?? '';
            form.single_dl_mbps.value = rec.single_dl_mbps ?? '';
            form.single_ul_mbps.value = rec.single_ul_mbps ?? '';
            form.multi_dl_mbps.value = rec.multi_dl_mbps ?? '';
            form.multi_ul_mbps.value = rec.multi_ul_mbps ?? '';
            form.test_target.value = rec.test_target || '';
        }
    }
    if (delId) {
        await fetch('/admin/tests', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ids: [Number(delId)]})
        });
        loadRecords(currentPage);
    }
});

document.getElementById('deleteSelected').addEventListener('click', async () => {
    const ids = Array.from(document.querySelectorAll('#recordsTable tbody input[type=checkbox]:checked')).map(cb => Number(cb.value));
    if (ids.length === 0) return;
    await fetch('/admin/tests', {
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ids})
    });
    loadRecords(currentPage);
});

document.getElementById('selectAll').addEventListener('change', e => {
    const checked = e.target.checked;
    document.querySelectorAll('#recordsTable tbody input[type=checkbox]').forEach(cb => cb.checked = checked);
});

document.getElementById('prevPage').addEventListener('click', () => {
    if (currentPage > 1) loadRecords(currentPage - 1);
});
document.getElementById('nextPage').addEventListener('click', () => {
    const totalPages = Math.ceil(totalRecords / pageSize);
    if (currentPage < totalPages) loadRecords(currentPage + 1);
});

document.getElementById('exportExcel').addEventListener('click', () => {
    if (!currentRecords.length) return;
    const header = ['Client IP','Date','Time','Location','ASN','ISP','Ping Avg(ms)','Ping Min(ms)','Ping Max(ms)','Single DL(Mbps)','Single UL(Mbps)','Multi DL(Mbps)','Multi UL(Mbps)','Target'];
    const rows = currentRecords.map(r => [r.client_ip || '', r.date || '', r.time_hour || '', r.location || '', r.asn || '', r.isp || '', r.ping_ms ?? '', r.ping_min_ms ?? '', r.ping_max_ms ?? '', r.single_dl_mbps ?? '', r.single_ul_mbps ?? '', r.multi_dl_mbps ?? '', r.multi_ul_mbps ?? '', r.test_target || '']);
    const csv = [header.join(','), ...rows.map(row => row.join(','))].join('\n');
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'records.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});

loadRecords();
</script>
</body>
</html>
